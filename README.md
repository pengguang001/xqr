# 什么是XQR？
XQR(XiangQi Replay)是一种全新的象棋棋谱格式，它有以下特点：
1. 二进制
2. 支持变着
3. 不加密
4. 带32位CRC检查
5. 精简，节省存储空间

# 为什么需要XQR？
目前流行的棋谱格式有诸多缺点：
* PGN - 文本格式，不支持变着，存在歧义，计算机处理起来不方便
* XQF - 加密的格式，设计比较混乱。另外，红黑选手名称只支持16字节（8个汉字）
* CBR - 私有格式，不开放

# XQR格式
XQR文件由多个TLV（type-length-value）序列组成，Type和Length各占一字节，Value部分长度由Length字段决定。XQR文件包含以下内容：
* 棋谱信息
* 着法
* CRC

1. 棋谱信息，一个或多个TLV。如果Value存放的是字符串，则以UTF8格式编码。目前定义的Type有：
* TYPE_MAGIC = 0
* TYPE_VERSION = 1
* TYPE_EVENT = 2
* TYPE_SITE = 3
* TYPE_DATE = 4
* TYPE_RED = 5
* TYPE_BLACK = 6 
* TYPE_RESULT = 7
* TYPE_FEN = 8
* TYPE_MOVE = 9
* TYPE_CRC = 10

第一个TLV为MAGIC数据，length为2，value部分必须为{0x20, 0x17}，否则这是一个非法的XQR文件。

如果碰到TYPE_MOVE的TLV，则棋谱信息部分结束。TYPE_MOVE为一个特殊的TLV，Length字段为0，后面跟的是着法数据。

2. 着法部分仅包含一个TLV，Type为TYPE_MOVE。由于此时不能确定Value部分即着法数据的总长度，它的Length为0。Value部分为一棵以左孩子右兄弟方式存储的树，每个节点表示一个着法。如果不包含评论，每个节点存储4字节数据：
```
[B0][B1][B2][B3]
```

B0和B1分别为FROM和TO，表示棋子的源位置和目的位置。高4位表示哪一行（0-9，从上到下递增），低4位表示哪一列（0-8，从左到右递增）。B2字节为FLAG，b0位置1表示有孩子节点，b1位置1表示有兄弟节点，b2位置1表示包含评论。B3字节为0，保留使用。

如果节点包含评论（B2b2=1），则后面跟的4字节表示评论长度，以Little-Endian存放，再往后跟的则是以UTF8编码的评论数据。
```
[B0][B1][B2][B3][B4][B5][B6][B7]comment...
```

树的根节点表示初始盘面，它的B2b1位不能为1（根节点不会包含兄弟节点）

树的存放方式：
```
saveTree(Node node) {
    save(node->data)
    if (有孩子节点）{
        saveTree(node->child);
    }

    if (有兄弟节点）{
        saveTree(node->sibling);
    }
}
```

3. 最后一个TLV为CRC数据，Length为4字节，Value部分为4字节的CRC校验，它覆盖从文件的第一个字节到本TLV的Type之前的那个字节的所有数据。

# 一个示例XQR文件
res目录中包含的1.xqr文件由1.pgn转化而来，这是2009年九城置业杯中国象棋年终总决赛蒋川先胜李雪松的棋谱.
```
$ hexdump -C 1.xqr
00000000  00 02 20 17 01 01 00 02  31 32 30 30 39 e5 b9 b4  |.. .....12009...|
00000010  e4 b9 9d e5 9f 8e e7 bd  ae e4 b8 9a e6 9d af e4  |................|
00000020  b8 ad e5 9b bd e8 b1 a1  e6 a3 8b e5 b9 b4 e7 bb  |................|
00000030  88 e6 80 bb e5 86 b3 e8  b5 9b 04 11 32 30 30 39  |............2009|
00000040  e5 b9 b4 31 32 e6 9c 88  31 39 e6 97 a5 03 18 e4  |...12...19......|
00000050  b8 8a e6 b5 b7 e5 b8 82  e5 8d a2 e6 b9 be e4 bd  |................|
00000060  93 e8 82 b2 e9 a6 86 05  0d e5 8c 97 e4 ba ac 20  |............... |
00000070  e8 92 8b e5 b7 9d 06 10  e6 b9 96 e5 8c 97 20 e6  |.............. .|
00000080  9d 8e e9 9b aa e6 9d be  07 01 01 09 00 00 00 01  |................|
00000090  00 71 74 01 00 01 22 01  00 91 72 01 00 00 01 01  |.qt..."...r.....|
000000a0  00 90 91 01 00 07 26 01  00 66 56 01 00 32 42 01  |......&..fV..2B.|
000000b0  00 91 31 01 00 21 20 01  00 31 32 01 00 20 10 01  |..1..! ..12.. ..|
*
00000900  00 84 74 01 00 87 66 01  00 74 75 00 00 0a 04 37  |..t...f..tu....7|
00000910  16 22 d4                                          |.".|
00000913

00-03: magic
04-06: version
07-39: event
3a-4c: date
4d-66: site
67-75: red
76-87: black
88-8a: result
8b-8c: mv
8d-90c: mv data
90d-912: crc (crc=0xd4221637)

解码的棋谱信息是：
[Event "2009年九城置业杯中国象棋年终总决赛"]
[Red "北京 蒋川"]
[Black "湖北 李雪松"]
[Result "1-0"]
[Date "2009年12月19日"]
[Site "上海市卢湾体育馆"]
```


# PGN转XQR

# XQF转XQR

# XQR转PGN

# XQR转XQF
